tinymce.PluginManager.add("footnotes",function(t){var n=null;function e(t,n){var e=t;for(var o in n)e=e.replace("{"+o+"}",n[o]);return e}function o(){var o=t.selection.getNode(),a=t.selection.getRng().endContainer,l="",r="SPAN"==o.tagName&&"fnoteWrap"===t.dom.getAttrib(o,"class"),c="fnoteWrap"==o.className?o.childNodes[0].firstChild.nodeValue.replace(/[^0-9]/g,""):o.childNodes[0];r&&(l=o.name||decodeURIComponent(o.childNodes[0].getAttribute("data-content"))||""),t.windowManager.open({title:"Insert contents for footnote",id:"footnote-dialog",body:{type:"textbox",name:"name",multiline:!0,minWidth:520,minHeight:100,value:l},onSubmit:function(i){var l,r='<span class="fnoteWrap" id="#wk_ft{FOOTNOTE_INDEX}" contenteditable="false"><button type="button" class="fnoteBtn" data-content="'+n+'">{FOOTNOTE_INDEX}</button></span>',s=t.getDoc().querySelectorAll(".fnoteBtn"),f=s.length;tinymce.activeEditor.destroy();var u=function(t){function n(t){return t.nextAll().find(".fnoteBtn").length>0?t.next().hasClass("fnoteBtn")?t.next().children().children():t.nextAll().find(".fnoteBtn"):"BODY"==t.prop("nodeName")?[]:n(t.parent())}function e(t,n){if(!n)return!1;if(n)return n;var o=null;return n.children().each(function(){n&&(o=e(t,$(this)))}),o}return function(t,o){for(var i=n(o);0!==i.length;){var a=e(t,i);if(null!==a)return a;i=n(i)}return i}(".fnoteBtn",t)}($(a));if(u.length){var d;for(u=u[0],d=0;d<f&&u!=s[d];d++);c<f?(l=e(r,{FOOTNOTE_INDEX:$(s[c-1]).html()}),t.selection.select(o)):(l=e(r,{FOOTNOTE_INDEX:$(s[d]).html()}),t.selection.collapse(0))}else l=e(r,{FOOTNOTE_INDEX:f+1}),t.selection.collapse(0);t.execCommand("mceInsertContent",!1,l),$(t.getDoc()).find(".fnoteBtn").each(function(t){$(this).text(t+1),$(this).parent().attr("id","#wk_ft"+(t+1))})}}),tinymce.init({selector:"#footnote-dialog textarea",content_css:"/css/frontend.css",forced_root_block:"div",skin:!1,branding:!1,statusbar:!0,menubar:!1,plugins:["link"],toolbar:"bold italic | link",setup:function(t){t.on("init",function(n){t.focus()}),t.on("keyup",function(e){n=i(n=t.getContent())}),t.on("change",function(e){n=i(n=t.getContent())})}})}function i(t){return t=(t=(t=t.replaceAll('"',"&quot;")).replaceAll("'","&apos;")).replace(/(\w+)\s*=\s*((&quot;)(.*?)\3|([^>\s]*)(?=\s|\/>))(?=[^<]*>)/g,"$1='$4'")}t.addCommand("mceFootnotes",o),t.addButton("footnotes",{title:"Insert footnote",image:tinyMCE.baseURL+"/tinymce/plugins/footnotesHtml/img/footnotes.png",onclick:o,stateSelector:"span.fnoteWrap"})});